{% extends 'base.html' %}

{% block content %}
<h4 class="mb-4">Carrito de Compras</h4>

<div id="carrito-items"></div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>DATOS DE ENVÍO</h5>
            </div>
            <div class="card-body">
                <form id="form-envio">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">NOMBRE</label>
                            <input type="text" class="form-control" id="nombre" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">APELLIDO</label>
                            <input type="text" class="form-control" id="apellido" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">RUT</label>
                        <input type="text" class="form-control" id="rut" placeholder="12.345.678-9" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">DIRECCIÓN</label>
                        <input type="text" class="form-control" id="direccion" required>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">REGIÓN</label>
                            <select class="form-control" id="region" required onchange="cargarComunas()">
                                <option value="">Seleccionar región</option>
                                <option value="Metropolitana">Región Metropolitana</option>
                                <option value="Valparaíso">Región de Valparaíso</option>
                                <option value="Biobío">Región del Biobío</option>
                                <option value="Araucanía">Región de La Araucanía</option>
                                <option value="Los Lagos">Región de Los Lagos</option>
                                <option value="Antofagasta">Región de Antofagasta</option>
                                <option value="Coquimbo">Región de Coquimbo</option>
                                <option value="O'Higgins">Región del Libertador General Bernardo O'Higgins</option>
                                <option value="Maule">Región del Maule</option>
                                <option value="Los Ríos">Región de Los Ríos</option>
                                <option value="Tarapacá">Región de Tarapacá</option>
                                <option value="Arica y Parinacota">Región de Arica y Parinacota</option>
                                <option value="Atacama">Región de Atacama</option>
                                <option value="Aysén">Región Aysén del General Carlos Ibáñez del Campo</option>
                                <option value="Magallanes">Región de Magallanes y de la Antártica Chilena</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">COMUNA</label>
                            <select class="form-control" id="comuna" required>
                                <option value="">Seleccionar comuna</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">PAÍS</label>
                            <select class="form-control" id="pais" required>
                                <option value="Chile" selected>Chile</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>RESUMEN DEL PEDIDO</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-3">
                    <span class="h5">TOTAL:</span>
                    <span class="h5 text-primary">$<span id="total">0</span></span>
                </div>
                <div class="mb-3">
                    <label class="form-label">Método de Pago:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="metodoPago" id="flow" value="flow" checked>
                        <label class="form-check-label" for="flow">
                            <i class="fas fa-credit-card me-2"></i>Flow (Chile)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="metodoPago" id="mercadopago" value="mercadopago">
                        <label class="form-check-label" for="mercadopago">
                            <i class="fab fa-cc-mastercard me-2"></i>MercadoPago
                        </label>
                    </div>
                </div>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-lg" onclick="procederPago()">PROCEDER AL PAGO</button>
                    <button class="btn btn-outline-danger" onclick="vaciarCarrito()">VACIAR CARRITO</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function mostrarCarrito() {
    const carritoItems = document.getElementById('carrito-items');
    const totalElement = document.getElementById('total');
    let total = 0;
    
    if (carrito.length === 0) {
        carritoItems.innerHTML = '<p class="text-muted">El carrito está vacío</p>';
        return;
    }
    
    let html = '';
    carrito.forEach((item, index) => {
        const subtotal = item.precio * item.cantidad;
        total += subtotal;
        html += `
            <div class="card mb-2">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <h6 class="mb-0">${item.nombre}</h6>
                            ${item.personalizacion ? `<small class="text-muted"><strong>Personalización:</strong> ${item.personalizacion}</small>` : ''}
                        </div>
                        <div class="col-md-2">$${item.precio}</div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <button class="btn btn-sm btn-outline-secondary" onclick="cambiarCantidad(${index}, -1)">-</button>
                                <span class="mx-2">${item.cantidad}</span>
                                <button class="btn btn-sm btn-outline-secondary" onclick="cambiarCantidad(${index}, 1)">+</button>
                            </div>
                        </div>
                        <div class="col-md-2">$${subtotal}</div>
                        <div class="col-md-1">
                            <button class="btn btn-sm btn-outline-danger" onclick="eliminarItem(${index})">×</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    carritoItems.innerHTML = html;
    totalElement.textContent = total;
}

function cambiarCantidad(index, cambio) {
    carrito[index].cantidad += cambio;
    if (carrito[index].cantidad <= 0) {
        carrito.splice(index, 1);
    }
    localStorage.setItem('carrito', JSON.stringify(carrito));
    mostrarCarrito();
    if (typeof actualizarContadorCarrito === 'function') {
        actualizarContadorCarrito();
    }
}

function eliminarItem(index) {
    carrito.splice(index, 1);
    localStorage.setItem('carrito', JSON.stringify(carrito));
    mostrarCarrito();
    if (typeof actualizarContadorCarrito === 'function') {
        actualizarContadorCarrito();
    }
}

function vaciarCarrito() {
    carrito = [];
    localStorage.setItem('carrito', JSON.stringify(carrito));
    mostrarCarrito();
    if (typeof actualizarContadorCarrito === 'function') {
        actualizarContadorCarrito();
    }
}

function procederPago() {
    if (carrito.length === 0) {
        Swal.fire({
            title: 'Carrito vacío',
            text: 'Agrega productos antes de proceder',
            icon: 'warning',
            confirmButtonColor: '#ffc1ea'
        });
        return;
    }
    
    // Validar datos de envío
    const nombre = document.getElementById('nombre')?.value;
    const apellido = document.getElementById('apellido')?.value;
    const rut = document.getElementById('rut')?.value;
    const direccion = document.getElementById('direccion')?.value;
    const region = document.getElementById('region')?.value;
    const comuna = document.getElementById('comuna')?.value;
    const pais = document.getElementById('pais')?.value;
    
    if (!nombre || !apellido || !rut || !direccion || !region || !comuna || !pais) {
        Swal.fire({
            title: 'Datos incompletos',
            text: 'Por favor completa todos los datos de envío',
            icon: 'error',
            confirmButtonColor: '#ffc1ea'
        });
        return;
    }
    
    // Obtener método de pago
    const metodoPago = document.querySelector('input[name="metodoPago"]:checked')?.value;
    if (!metodoPago) {
        Swal.fire({
            title: 'Método de pago',
            text: 'Selecciona un método de pago',
            icon: 'error',
            confirmButtonColor: '#ffc1ea'
        });
        return;
    }
    
    // Preparar datos
    const datosEnvio = {
        nombre, apellido, rut, direccion, region, comuna, pais,
        email: `${nombre.toLowerCase()}@correo.cl` // Email temporal
    };
    
    // Mostrar loading
    Swal.fire({
        title: 'Procesando pago...',
        text: 'Por favor espera',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    // Enviar al backend
    fetch('/procesar-pago/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            carrito: carrito,
            datosEnvio: datosEnvio,
            metodoPago: metodoPago
        })
    })
    .then(response => {
        // Verificar si la respuesta es JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Respuesta no es JSON válido');
        }
        return response.json();
    })
    .then(data => {
        if (data.url) {
            // Limpiar carrito y redirigir
            localStorage.removeItem('carrito');
            window.location.href = data.url;
        } else {
            throw new Error(data.error || 'Error al procesar el pago');
        }
    })
    .catch(error => {
        console.error('Error en procesar pago:', error);
        Swal.fire({
            title: 'Error',
            text: error.message || 'Error al procesar el pago',
            icon: 'error',
            confirmButtonColor: '#ffc1ea'
        });
    });
}

// Función para obtener cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Función para cargar comunas según región
function cargarComunas() {
    const region = document.getElementById('region').value;
    const comunaSelect = document.getElementById('comuna');
    
    // Limpiar comunas
    comunaSelect.innerHTML = '<option value="">Seleccionar comuna</option>';
    
    const comunasPorRegion = {
        'Metropolitana': ['Santiago', 'Las Condes', 'Providencia', 'Ñuñoa', 'La Reina', 'Vitacura', 'Lo Barnechea', 'Maipú', 'Puente Alto', 'La Florida', 'San Miguel', 'La Cisterna', 'El Bosque', 'Pedro Aguirre Cerda', 'Lo Espejo', 'Cerrillos', 'Estación Central', 'Quinta Normal', 'Renca', 'Conchalí', 'Huechuraba', 'Quilicura', 'Pudahuel', 'Lo Prado', 'Cerro Navia', 'Peñalolén', 'Macul', 'San Joaquín', 'La Granja', 'San Ramón', 'La Pintana', 'El Bosque'],
        'Valparaíso': ['Valparaíso', 'Viña del Mar', 'Concón', 'Quilpué', 'Villa Alemana', 'Casablanca', 'San Antonio', 'Cartagena', 'El Quisco', 'Algarrobo'],
        'Biobío': ['Concepción', 'Talcahuano', 'Chillán', 'Los Ángeles', 'Coronel', 'San Pedro de la Paz', 'Hualqui', 'Penco', 'Tomé', 'Lota'],
        'Araucanía': ['Temuco', 'Padre Las Casas', 'Villarrica', 'Pucón', 'Angol', 'Victoria', 'Lautaro', 'Nueva Imperial'],
        'Los Lagos': ['Puerto Montt', 'Osorno', 'Castro', 'Ancud', 'Puerto Varas', 'Frutillar', 'Llanquihue'],
        'Antofagasta': ['Antofagasta', 'Calama', 'Tocopilla', 'Mejillones', 'Taltal'],
        'Coquimbo': ['La Serena', 'Coquimbo', 'Ovalle', 'Illapel', 'Vicuña'],
        "O'Higgins": ['Rancagua', 'San Fernando', 'Rengo', 'Machalí', 'Graneros'],
        'Maule': ['Talca', 'Curicó', 'Linares', 'Molina', 'Constitución'],
        'Los Ríos': ['Valdivia', 'La Unión', 'Río Bueno', 'Panguipulli'],
        'Tarapacá': ['Iquique', 'Alto Hospicio', 'Pozo Almonte'],
        'Arica y Parinacota': ['Arica', 'Putre'],
        'Atacama': ['Copiapó', 'Caldera', 'Vallenar', 'Chañaral'],
        'Aysén': ['Coyhaique', 'Puerto Aysén', 'Chile Chico'],
        'Magallanes': ['Punta Arenas', 'Puerto Natales', 'Porvenir']
    };
    
    if (region && comunasPorRegion[region]) {
        comunasPorRegion[region].forEach(comuna => {
            const option = document.createElement('option');
            option.value = comuna;
            option.textContent = comuna;
            comunaSelect.appendChild(option);
        });
    }
}

document.addEventListener('DOMContentLoaded', mostrarCarrito);
</script>
{% endblock %}