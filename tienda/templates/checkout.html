{% extends 'base.html' %}

{% block content %}
<div class="checkout-container">
    <div class="row">
        <!-- Columna izquierda: Formulario -->
        <div class="col-lg-8">
            <div class="checkout-form">
                <h2 class="checkout-title">Finalizar Compra</h2>
                
                <!-- 1. Contacto -->
                <div class="form-section">
                    <h4 class="section-title">1. Contacto</h4>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">E-mail *</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Número telefónico *</label>
                            <div class="input-group">
                                <span class="input-group-text">+56</span>
                                <input type="tel" class="form-control" id="telefono" required>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Envío -->
                <div class="form-section">
                    <h4 class="section-title">2. Método de Envío</h4>
                    <div class="shipping-options">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="tipoEnvio" id="starken" value="starken" checked>
                            <label class="form-check-label" for="starken">
                                <i class="fas fa-shipping-fast me-2"></i>Starken - <span class="shipping-price" id="precio-starken">Ingresa dirección</span>
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="tipoEnvio" id="bluexpress" value="bluexpress">
                            <label class="form-check-label" for="bluexpress">
                                <i class="fas fa-truck me-2"></i>BlueExpress - <span class="shipping-price" id="precio-bluexpress">Ingresa dirección</span>
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="tipoEnvio" id="retiroTienda" value="retiro">
                            <label class="form-check-label" for="retiroTienda">
                                <i class="fas fa-store me-2"></i>Retiro en tienda - Gratis
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 3. Dirección de envío -->
                <div class="form-section" id="direccionSection">
                    <h4 class="section-title">3. Dirección de envío</h4>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre *</label>
                            <input type="text" class="form-control" id="nombre" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Apellido *</label>
                            <input type="text" class="form-control" id="apellido" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">RUT *</label>
                            <input type="text" class="form-control" id="rut" placeholder="12.345.678-9" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Teléfono *</label>
                            <div class="input-group">
                                <span class="input-group-text">+56</span>
                                <input type="tel" class="form-control" id="telefonoEnvio" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Estado / Región *</label>
                            <select class="form-control" id="region" required>
                                <option value="">Seleccionar región</option>
                                <option value="Metropolitana">Región Metropolitana</option>
                                <option value="Valparaíso">Región de Valparaíso</option>
                                <option value="Biobío">Región del Biobío</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ciudad *</label>
                            <input type="text" class="form-control" id="ciudad" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Dirección *</label>
                        <input type="text" class="form-control" id="direccion" placeholder="Calle y número" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Apartamento, casa, puerta, etc. (opcional)</label>
                        <input type="text" class="form-control" id="complemento">
                    </div>

                </div>

                <!-- 4. Confirmaciones -->
                <div class="form-section">
                    <h4 class="section-title">4. Confirmaciones</h4>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="confirmarTiempo" required>
                        <label class="form-check-label" for="confirmarTiempo">
                            Confirmo que el pedido será preparado y despachado en 3-5 días hábiles
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="aceptarCondiciones" required>
                        <label class="form-check-label" for="aceptarCondiciones">
                            Acepto las condiciones de envío y términos de servicio
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="autorizarDatos">
                        <label class="form-check-label" for="autorizarDatos">
                            Autorizo el uso de mis datos para seguimiento y contacto
                        </label>
                    </div>
                </div>

                <!-- 5. Notas -->
                <div class="form-section">
                    <h4 class="section-title">5. Notas o comentarios</h4>
                    <textarea class="form-control" id="notas" rows="3" placeholder="Deja un mensaje para el vendedor (opcional)"></textarea>
                </div>

                <!-- 6. Método de Pago -->
                <div class="form-section">
                    <h4 class="section-title">6. Método de Pago</h4>
                    <div class="payment-methods">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="metodoPago" id="flow" value="flow" checked>
                            <label class="form-check-label" for="flow">
                                <i class="fas fa-credit-card me-2"></i>Flow (Chile)
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="metodoPago" id="mercadopago" value="mercadopago">
                            <label class="form-check-label" for="mercadopago">
                                <i class="fab fa-cc-mastercard me-2"></i>MercadoPago
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Botón de acción -->
                <div class="form-section">
                    <button class="btn btn-checkout btn-lg w-100" onclick="procesarPedido()">
                        FINALIZAR COMPRA
                    </button>
                </div>
            </div>
        </div>

        <!-- Columna derecha: Resumen del pedido -->
        <div class="col-lg-4">
            <div class="order-summary">
                <h4 class="summary-title">Resumen del pedido</h4>
                
                <div id="productos-resumen"></div>
                
                <div class="discount-section">
                    <label class="form-label">Código de descuento</label>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="codigoDescuento" placeholder="Ingresa tu código">
                        <button class="btn btn-outline-secondary" onclick="aplicarDescuento()">APLICAR</button>
                    </div>
                </div>
                
                <div class="summary-totals">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">$0</span>
                    </div>
                    <div class="summary-row" id="envio-row" style="display: none;">
                        <span>Envío:</span>
                        <span id="costo-envio">$0</span>
                    </div>
                    <div class="summary-row">
                        <span>Descuento:</span>
                        <span id="descuento">$0</span>
                    </div>
                    <div class="summary-row total-row">
                        <span>Total:</span>
                        <span id="total">$0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.checkout-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
}

.checkout-form {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
}

.checkout-title {
    font-size: 1.8rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 2rem;
    text-align: center;
}

.form-section {
    margin-bottom: 2.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #f0f0f0;
}

.form-section:last-child {
    border-bottom: none;
}

.section-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
}

.section-title::before {
    content: '';
    width: 4px;
    height: 20px;
    background: var(--color-primario);
    margin-right: 10px;
    border-radius: 2px;
}

.form-label {
    font-weight: 500;
    color: #555;
    margin-bottom: 0.5rem;
}

.form-control {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 0.75rem;
    transition: border-color 0.3s ease;
}

.form-control:focus {
    border-color: var(--color-primario);
    box-shadow: 0 0 0 0.2rem rgba(255,193,234,0.25);
}

.shipping-options .form-check-label {
    font-weight: 500;
    cursor: pointer;
}

.payment-methods .form-check-label {
    font-weight: 500;
    cursor: pointer;
}

.btn-checkout {
    background: var(--color-primario);
    border: none;
    color: white;
    padding: 1rem 2rem;
    border-radius: 8px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
}

.btn-checkout:hover {
    background: var(--color-hover);
    color: white;
    transform: translateY(-2px);
}

.order-summary {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    position: sticky;
    top: 2rem;
}

.summary-title {
    font-size: 1.3rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 1.5rem;
    text-align: center;
}

.product-summary {
    display: flex;
    align-items: center;
    padding: 1rem 0;
    border-bottom: 1px solid #f0f0f0;
}

.product-summary img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 8px;
    margin-right: 1rem;
}

.product-info h6 {
    margin: 0;
    font-size: 0.9rem;
    font-weight: 500;
}

.product-info .quantity {
    font-size: 0.8rem;
    color: #666;
}

.product-price {
    margin-left: auto;
    font-weight: 600;
    color: #333;
}

.discount-section {
    margin: 1.5rem 0;
}

.summary-totals {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #f0f0f0;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.8rem;
    font-size: 0.95rem;
}

.total-row {
    font-size: 1.2rem;
    font-weight: 600;
    color: #333;
    padding-top: 0.8rem;
    border-top: 1px solid #ddd;
}

@media (max-width: 768px) {
    .checkout-container {
        padding: 1rem;
    }
    
    .checkout-form, .order-summary {
        padding: 1.5rem;
    }
    
    .order-summary {
        margin-top: 2rem;
        position: static;
    }
}
</style>

<script>
let carrito = JSON.parse(localStorage.getItem('carrito')) || [];

document.addEventListener('DOMContentLoaded', function() {
    mostrarResumenPedido();
    
    // Toggle sección dirección
    document.querySelectorAll('input[name="tipoEnvio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            document.getElementById('direccionSection').style.display = 
                this.value === 'retiro' ? 'none' : 'block';
            actualizarTotal();
        });
    });
    
    // Auto-calcular envíos cuando se complete la dirección
    const direccionInputs = ['region', 'ciudad', 'direccion'];
    direccionInputs.forEach(inputId => {
        document.getElementById(inputId).addEventListener('change', calcularEnviosAutomatico);
        document.getElementById(inputId).addEventListener('input', debounce(calcularEnviosAutomatico, 1000));
    });
});

function mostrarResumenPedido() {
    const productosResumen = document.getElementById('productos-resumen');
    const subtotalElement = document.getElementById('subtotal');
    const totalElement = document.getElementById('total');
    
    let subtotal = 0;
    let html = '';
    
    carrito.forEach(item => {
        const itemTotal = item.precio * item.cantidad;
        subtotal += itemTotal;
        
        html += `
            <div class="product-summary">
                ${item.imagen ? 
                    `<img src="${item.imagen}" alt="${item.nombre}">` :
                    `<div style="width: 60px; height: 60px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px;">IMG</div>`
                }
                <div class="product-info">
                    <h6>${item.nombre}</h6>
                    <div class="quantity">Cantidad: ${item.cantidad}</div>
                </div>
                <div class="product-price">$${itemTotal.toLocaleString()}</div>
            </div>
        `;
    });
    
    productosResumen.innerHTML = html;
    subtotalElement.textContent = `$${subtotal.toLocaleString()}`;
    totalElement.textContent = `$${subtotal.toLocaleString()}`;
}

function aplicarDescuento() {
    // Implementar lógica de descuento
    alert('Función de descuento por implementar');
}

function procesarPedido() {
    // Validar campos obligatorios
    const email = document.getElementById('email').value;
    const telefono = document.getElementById('telefono').value;
    
    if (!email || !telefono) {
        alert('Por favor completa todos los campos obligatorios');
        return;
    }
    
    // Validar términos y condiciones
    if (!document.getElementById('confirmarTiempo').checked || 
        !document.getElementById('aceptarCondiciones').checked) {
        alert('Debes aceptar las confirmaciones obligatorias');
        return;
    }
    
    const tipoEnvio = document.querySelector('input[name="tipoEnvio"]:checked').value;
    
    if (tipoEnvio !== 'retiro') {
        const nombre = document.getElementById('nombre').value;
        const apellido = document.getElementById('apellido').value;
        const rut = document.getElementById('rut').value;
        const telefonoEnvio = document.getElementById('telefonoEnvio').value;
        const direccion = document.getElementById('direccion').value;
        
        if (!nombre || !apellido || !rut || !telefonoEnvio || !direccion) {
            alert('Por favor completa todos los datos de envío');
            return;
        }
    }
    
    const metodoPago = document.querySelector('input[name="metodoPago"]:checked').value;
    
    // Preparar datos para envío
    const datosEnvio = {
        email: email,
        telefono: telefono,
        tipoEnvio: tipoEnvio,
        nombre: document.getElementById('nombre').value,
        apellido: document.getElementById('apellido').value,
        rut: document.getElementById('rut').value,
        telefonoEnvio: document.getElementById('telefonoEnvio').value,
        direccion: document.getElementById('direccion').value,
        notas: document.getElementById('notas').value
    };
    
    // Procesar pago
    fetch('/procesar-pago/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            carrito: carrito,
            datosEnvio: datosEnvio,
            metodoPago: metodoPago
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.url) {
            localStorage.removeItem('carrito');
            window.location.href = data.url;
        } else {
            alert(data.error || 'Error al procesar el pago');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al procesar el pago');
    });
}

function calcularEnviosAutomatico() {
    const region = document.getElementById('region').value;
    const ciudad = document.getElementById('ciudad').value;
    const direccion = document.getElementById('direccion').value;
    
    if (region && ciudad && direccion) {
        document.getElementById('precio-starken').textContent = 'Calculando...';
        document.getElementById('precio-bluexpress').textContent = 'Calculando...';
        
        // Calcular peso total del carrito
        const pesoTotal = carrito.reduce((total, item) => total + (item.peso || 1) * item.cantidad, 0);
        
        fetch('/calcular-envio/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                region: region,
                ciudad: ciudad,
                direccion: direccion,
                peso: pesoTotal
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.starken) {
                document.getElementById('precio-starken').textContent = `$${data.starken.toLocaleString()}`;
            } else {
                document.getElementById('precio-starken').textContent = 'No disponible';
            }
            
            if (data.bluexpress) {
                document.getElementById('precio-bluexpress').textContent = `$${data.bluexpress.toLocaleString()}`;
            } else {
                document.getElementById('precio-bluexpress').textContent = 'No disponible';
            }
            
            actualizarTotal();
        })
        .catch(error => {
            console.error('Error calculando envío:', error);
            document.getElementById('precio-starken').textContent = 'Error';
            document.getElementById('precio-bluexpress').textContent = 'Error';
        });
    }
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function actualizarTotal() {
    const subtotalElement = document.getElementById('subtotal');
    const totalElement = document.getElementById('total');
    const costoEnvioElement = document.getElementById('costo-envio');
    const envioRow = document.getElementById('envio-row');
    
    let subtotal = carrito.reduce((total, item) => total + (item.precio * item.cantidad), 0);
    let costoEnvio = 0;
    
    const tipoEnvioSeleccionado = document.querySelector('input[name="tipoEnvio"]:checked')?.value;
    if (tipoEnvioSeleccionado === 'starken') {
        const precioTexto = document.getElementById('precio-starken').textContent;
        if (precioTexto.includes('$')) {
            costoEnvio = parseInt(precioTexto.replace(/[^0-9]/g, ''));
        }
    } else if (tipoEnvioSeleccionado === 'bluexpress') {
        const precioTexto = document.getElementById('precio-bluexpress').textContent;
        if (precioTexto.includes('$')) {
            costoEnvio = parseInt(precioTexto.replace(/[^0-9]/g, ''));
        }
    }
    
    // Mostrar/ocultar fila de envío
    if (costoEnvio > 0) {
        costoEnvioElement.textContent = `$${costoEnvio.toLocaleString()}`;
        envioRow.style.display = 'flex';
    } else {
        envioRow.style.display = 'none';
    }
    
    totalElement.textContent = `$${(subtotal + costoEnvio).toLocaleString()}`;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}